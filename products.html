<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>CG มาเช่ - เมนูทั้งหมด</title>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;700;900&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="assets/js/tailwind-config.js"></script>
    <!-- Firebase importmap removed for local storage implementation -->
    <style>
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {
                bottom: 0px;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadein {
            from {
                bottom: 0px;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @-webkit-keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0px;
                opacity: 0;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0px;
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-background-light text-text-main transition-colors duration-200">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <header
            class="sticky top-0 z-50 w-full border-b border-[#e5e5e5] bg-white/90 backdrop-blur-md dark:border-[#333] dark:bg-[#191919]/90">
            <div class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8">
                <div class="flex items-center gap-8">
                    <a class="flex items-center gap-2 group" href="index.html">
                        <div
                            class="flex h-8 w-8 items-center justify-center rounded bg-primary text-white dark:bg-white dark:text-primary">
                            <span class="material-symbols-outlined text-[20px]">potted_plant</span>
                        </div>
                        <h1
                            class="text-lg font-bold tracking-tight text-primary group-hover:opacity-80 transition-opacity">
                            CG มาเช่</h1>
                    </a>
                    <div class="relative inline-block text-left">
                        <button type="button" id="menu-button" onclick="toggleMenu()"
                            class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-[#333] rounded-lg text-sm font-bold hover:bg-gray-200 transition-all">
                            <span class="material-symbols-outlined">menu</span>
                            เมนูหลัก
                            <span class="material-symbols-outlined text-xs transition-transform duration-200"
                                id="menu-arrow">keyboard_arrow_down</span>
                        </button>

                        <div id="menu-dropdown"
                            class="absolute left-0 mt-2 w-48 origin-top-left rounded-xl bg-white dark:bg-[#222] shadow-xl ring-1 ring-black ring-opacity-5 focus:outline-none hidden transition-all duration-200 z-[100] border border-gray-100 dark:border-gray-800 opacity-0 bg-opacity-0 scale-95 transform">
                            <div class="py-2">
                                <a href="index.html"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#333]">
                                    <span class="material-symbols-outlined text-lg">home</span> หน้าหลัก
                                </a>
                                <a href="products.html"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#333]">
                                    <span class="material-symbols-outlined text-lg">shopping_bag</span> สินค้า
                                </a>
                                <a href="about.html"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#333]">
                                    <span class="material-symbols-outlined text-lg">info</span> เกี่ยวกับเรา
                                </a>
                                <a href="history.html"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#333]">
                                    <span class="material-symbols-outlined text-lg">receipt_long</span>
                                    ประวัติการสั่งซื้อ
                                </a>
                                <a href="checkout.html"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#333]">
                                    <span class="material-symbols-outlined text-lg">shopping_cart</span> ตะกร้าสินค้า
                                </a>
                                <div class="border-t border-gray-100 dark:border-gray-800 my-1"></div>
                                <a href="https://www.facebook.com/grace.wongsakorn.2024" target="_blank"
                                    class="flex items-center gap-3 px-4 py-3 text-sm text-blue-600 hover:bg-gray-50 dark:hover:bg-[#333]">
                                    <span class="material-symbols-outlined text-lg">chat</span> ติดต่อเรา
                                </a>
                            </div>
                        </div>
                    </div>
                    <script>
                        function toggleMenu() {
                            const dropdown = document.getElementById('menu-dropdown');
                            const arrow = document.getElementById('menu-arrow');

                            if (dropdown.classList.contains('hidden')) {
                                dropdown.classList.remove('hidden');
                                setTimeout(() => {
                                    dropdown.classList.remove('opacity-0', 'bg-opacity-0', 'scale-95');
                                    dropdown.classList.add('opacity-100', 'scale-100');
                                }, 10);
                                arrow.classList.add('rotate-180');
                            } else {
                                dropdown.classList.remove('opacity-100', 'scale-100');
                                dropdown.classList.add('opacity-0', 'bg-opacity-0', 'scale-95');
                                arrow.classList.remove('rotate-180');
                                setTimeout(() => {
                                    dropdown.classList.add('hidden');
                                }, 200);
                            }
                        }

                        document.addEventListener('click', function (event) {
                            const isClickInside = document.getElementById('menu-button').contains(event.target) ||
                                document.getElementById('menu-dropdown').contains(event.target);

                            if (!isClickInside) {
                                const dropdown = document.getElementById('menu-dropdown');
                                const arrow = document.getElementById('menu-arrow');
                                if (dropdown && !dropdown.classList.contains('hidden')) {
                                    dropdown.classList.remove('opacity-100', 'scale-100');
                                    dropdown.classList.add('opacity-0', 'bg-opacity-0', 'scale-95');
                                    arrow.classList.remove('rotate-180');
                                    setTimeout(() => {
                                        dropdown.classList.add('hidden');
                                    }, 200);
                                }
                            }
                        });
                    </script>
                </div>
                <div class="flex items-center gap-4">
                    <div
                        class="hidden sm:flex w-full max-w-[240px] items-center rounded-lg bg-[#f2f2f2] px-3 py-1.5 focus-within:ring-1 focus-within:ring-primary dark:bg-[#2a2a2a]">
                        <span class="material-symbols-outlined text-[20px] text-text-muted">search</span>
                        <input id="search-input"
                            class="ml-2 w-full border-none bg-transparent p-0 text-sm placeholder-text-muted focus:ring-0 dark:text-white text-primary font-normal"
                            placeholder="ค้นหา..." type="text" />
                    </div>
                    <script>
                        document.getElementById('search-input').addEventListener('keypress', function (e) {
                            if (e.key === 'Enter') {
                                const query = e.target.value.trim();
                                if (query) {
                                    window.location.href = `products.html?search=${encodeURIComponent(query)}`;
                                }
                            }
                        });
                    </script>

                    <div class="flex items-center gap-2" id="auth-buttons">
                        <a href="login.html"
                            class="hidden lg:flex items-center justify-center h-9 px-4 rounded-lg text-sm font-bold text-primary hover:bg-[#f2f2f2] dark:text-white dark:hover:bg-[#333] transition-colors">
                            เข้าสู่ระบบ
                        </a>
                        <a href="register.html"
                            class="flex items-center justify-center h-9 px-4 rounded-lg bg-primary text-white text-sm font-bold hover:bg-primary/90 dark:bg-white dark:text-primary dark:hover:bg-gray-200 transition-colors shadow-sm">
                            สมัครสมาชิก
                        </a>
                    </div>

                    <a href="checkout.html"
                        class="relative flex items-center justify-center rounded-lg size-10 bg-white border border-[#e5e5e5] hover:bg-gray-100 dark:bg-[#333] dark:border-[#444] dark:hover:bg-[#444] transition-colors">
                        <span class="material-symbols-outlined dark:text-white">shopping_cart</span>
                        <span id="cart-badge"
                            class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
                    </a>

                </div>
            </div>
        </header>

        <main class="flex-1">
            <!-- Premium Page Header -->
            <div class="relative bg-black py-16 sm:py-24">
                <div class="absolute inset-0 overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-black via-[#111] to-[#222]"></div>
                    <!-- Subtle Gold Pattern/Glow -->
                    <div
                        class="absolute top-0 right-0 -mr-20 -mt-20 h-96 w-96 rounded-full bg-primary/10 blur-3xl filter">
                    </div>
                </div>
                <div class="relative mx-auto max-w-7xl px-4 text-center sm:px-6 lg:px-8">
                    <h1
                        class="text-4xl font-black uppercase tracking-tight text-white sm:text-5xl md:text-6xl drop-shadow-lg">
                        สินค้าทั้งหมด <span class="text-primary">(Products)</span>
                    </h1>
                    <p class="mx-auto mt-4 max-w-xl text-lg text-gray-300">
                        ศูนย์รวมผักสวนครัวและผักออร์แกนิกสดใหม่จากฟาร์ม คัดสรรเพื่อสุขภาพที่ดีของคุณ
                    </p>
                </div>
            </div>

            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 -mt-8 relative z-30">
                <!-- Glass Filter Bar -->
                <div
                    class="flex flex-wrap items-center justify-center gap-2 rounded-2xl border border-white/20 bg-white/10 p-2 backdrop-blur-xl shadow-xl dark:bg-black/40">
                    <button onclick="filterProducts('all')" data-category="all"
                        class="cursor-pointer px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 hover:bg-white/20 hover:text-white text-gray-700 bg-white shadow-sm dark:bg-white dark:text-black">
                        ทั้งหมด
                    </button>
                    <button onclick="filterProducts('vegetable')" data-category="vegetable"
                        class="cursor-pointer px-6 py-2.5 rounded-xl text-sm font-bold text-white transition-all duration-300 hover:bg-white/20">
                        ผักสวนครัว (Vegetables)
                    </button>
                    <button onclick="filterProducts('organic')" data-category="organic"
                        class="cursor-pointer px-6 py-2.5 rounded-xl text-sm font-bold text-white transition-all duration-300 hover:bg-white/20">
                        ผักออร์แกนิก (Organic)
                    </button>
                    <button onclick="filterProducts('seeds')" data-category="seeds"
                        class="cursor-pointer px-6 py-2.5 rounded-xl text-sm font-bold text-white transition-all duration-300 hover:bg-white/20">
                        เมล็ดพันธุ์/อุปกรณ์ (Seeds)
                    </button>
                </div>
            </div>

            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-12">



                <div id="product-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </main>

        <div id="toast">เพิ่มสินค้าลงตะกร้าแล้ว!</div>

        <script type="module">
            import { initProductListener } from './assets/js/products-utils.js';
            import { updateAuthUI } from './assets/js/auth-utils.js';

            // Just in case DOMContentLoaded fired early or module loaded late
            window.updateAuthUI = updateAuthUI;
            updateAuthUI();

            document.addEventListener('DOMContentLoaded', () => {
                updateAuthUI();
            });

            let products = [];

            // Attach functions to window for inline onclick handlers
            window.addToCart = addToCart;
            window.filterProducts = filterProducts;

            // 2. ฟังก์ชันแสดงสินค้า
            function renderProducts(filter, searchQuery = '') {
                const container = document.getElementById('product-container');
                container.innerHTML = ''; // ล้างของเก่า

                // NORMALIZE DATA: Fix legacy categories to match new IDs
                products = products.map(p => {
                    let cat = p.category ? p.category.toLowerCase() : 'other';
                    // Legacy Map
                    if (cat === 'somtum' || cat === 'พระเครื่อง' || cat === 'amulet') cat = 'vegetable';
                    if (cat === 'side' || cat === 'เครื่องราง' || cat === 'statue') cat = 'organic';
                    if (cat === 'drink' || cat === 'อุปกรณ์' || cat === 'accessories') cat = 'seeds';
                    return { ...p, category: cat };
                });

                // Case 1: Loading
                if (!products) {
                    container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">กำลังโหลดสินค้า...</div>';
                    return;
                }

                const searchLower = searchQuery ? searchQuery.toLowerCase() : '';

                // Helper to render a grid of products
                const renderGrid = (productList) => {
                    let html = '';
                    productList.forEach(product => {
                        html += `
                <div class="group relative flex flex-col overflow-hidden rounded-2xl bg-white shadow-sm transition-all duration-500 hover:shadow-2xl hover:-translate-y-2 dark:bg-[#222] border border-gray-100 dark:border-gray-800">
                    <!-- Image Area -->
                    <div class="relative aspect-square w-full overflow-hidden bg-gray-50 dark:bg-[#1a1a1a] p-6">
                        <img src="${product.image}" alt="${product.name}" 
                             class="h-full w-full object-cover mix-blend-multiply dark:mix-blend-normal transition-transform duration-700 group-hover:scale-110">
                        
                        <!-- Quick Action overlay -->
                        <div class="absolute inset-x-0 bottom-0 p-4 translate-y-full transition-transform duration-300 group-hover:translate-y-0">
                            <button onclick="addToCart('${product.id}')" 
                                class="w-full rounded-xl bg-primary py-3 text-sm font-bold text-white shadow-lg transition-colors hover:bg-primary-hover active:scale-95 flex items-center justify-center gap-2">
                                <span class="material-symbols-outlined text-[20px]">add_shopping_cart</span>
                                เพิ่มลงตะกร้า
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex flex-1 flex-col p-5">
                        <div class="mb-2">
                            <span class="inline-block rounded-md bg-gray-100 dark:bg-[#333] px-2 py-1 text-[10px] font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                                ${product.category}
                            </span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 group-hover:text-primary dark:text-gray-100 line-clamp-1" title="${product.name}">
                            ${product.name}
                        </h3>
                        <p class="mt-1 text-xs text-gray-500 line-clamp-2 min-h-[2.5em]">${product.desc}</p>
                        
                        <div class="mt-4 flex items-center justify-between border-t border-gray-100 dark:border-gray-700 pt-4">
                            <div class="flex flex-col">
                                <span class="text-xs text-gray-400">ราคา</span>
                                <span class="text-xl font-black text-primary">฿${product.price ? product.price.toLocaleString() : '0'}</span>
                            </div>
                            <button onclick="addToCart('${product.id}')" 
                                class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-primary hover:text-white dark:bg-[#333] dark:text-gray-300 lg:hidden">
                                <span class="material-symbols-outlined text-[20px]">add</span>
                            </button>
                        </div>
                    </div>
                </div>
                `;
                    });
                    return html;
                };

                // Case 1: Search is active - Show flat list of matches
                if (searchQuery) {
                    const filteredProducts = products.filter(product =>
                        product.name.toLowerCase().includes(searchLower) ||
                        (product.desc && product.desc.toLowerCase().includes(searchLower))
                    );

                    if (filteredProducts.length === 0) {
                        container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">ไม่พบสินค้าที่คุณค้นหา</div>';
                        return;
                    }
                    // Make container a grid for search results
                    container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
                    container.innerHTML = renderGrid(filteredProducts);
                    return;
                }

                // Case 2: Filter is specific category
                if (filter !== 'all') {
                    const categoryProducts = products.filter(p => p.category === filter);
                    if (categoryProducts.length === 0) {
                        container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">ไม่มีสินค้าในหมวดหมู่นี้</div>';
                        return;
                    }
                    container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
                    container.innerHTML = renderGrid(categoryProducts);
                    return;
                }

                // Case 3: Show All (Categorized Sections)
                container.className = "flex flex-col gap-12"; // Use flex column for sections

                const categories = [
                    { id: 'vegetable', title: 'ผักสวนครัว (Vegetables)' },
                    { id: 'organic', title: 'ผักออร์แกนิก (Organic)' },
                    { id: 'seeds', title: 'เมล็ดพันธุ์/อุปกรณ์ (Seeds)' }
                ];

                let hasProducts = false;
                categories.forEach(cat => {
                    const catProducts = products.filter(p => p.category === cat.id);
                    if (catProducts.length > 0) {
                        hasProducts = true;
                        const sectionHtml = `
                        <div class="w-full">
                            <div class="flex items-center gap-4 mb-6">
                                <h2 class="text-2xl font-black text-primary">${cat.title}</h2>
                                <div class="h-1 flex-1 bg-gray-100 rounded-full"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${renderGrid(catProducts)}
                            </div>
                        </div>
                    `;
                        container.innerHTML += sectionHtml;
                    }
                });

                if (!hasProducts) {
                    container.innerHTML = `
                    <div class="col-span-full py-20 text-center flex flex-col items-center justify-center">
                        <div class="p-6 bg-gray-50 rounded-full mb-4">
                            <span class="material-symbols-outlined text-4xl text-gray-300">inventory_2</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">ยังไม่มีสินค้าในระบบ</h3>
                        <p class="text-gray-500 max-w-md mx-auto">กรุณาไปที่หน้า Admin เพื่อกด "กู้คืนสินค้า (Restore)" หรือเพิ่มสินค้าใหม่</p>
                    </div>
                `;
                }
            }

            // 3. ฟังก์ชันใส่ตะกร้า (บันทึกเช้า LocalStorage)
            function addToCart(productId) {
                // Note: products is now a global variable updated by listener
                // Ideally should ensure string/number ID match
                // Firestore IDs are strings, old IDs might be numbers.
                const product = products.find(p => p.id == productId);
                let cart = JSON.parse(localStorage.getItem('cart')) || [];

                if (!product) {
                    console.error("Product not found for ID:", productId);
                    return;
                }

                // เช็คว่ามีของชิ้นนี้ในตะกร้าหรือยัง
                const existingItem = cart.find(item => item.id == productId);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }

                localStorage.setItem('cart', JSON.stringify(cart));
                updateBadge();
                showToast();
            }

            // 4. อัปเดตตัวเลขสีแดงบนตะกร้า
            function updateBadge() {
                const cart = JSON.parse(localStorage.getItem('cart')) || [];
                const badge = document.getElementById('cart-badge');
                const count = cart.reduce((acc, item) => acc + item.quantity, 0);

                if (count > 0) {
                    badge.innerText = count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            // 5. แจ้งเตือน Popup
            function showToast() {
                var x = document.getElementById("toast");
                x.className = "show";
                setTimeout(function () { x.className = x.className.replace("show", ""); }, 3000);
            }

            // 6. กรองสินค้า และ อัปเดตปุ่ม
            function filterProducts(categoryInput, searchQuery = null) {
                // If called from button click, categoryInput is the category string
                // If called from load, we might handle logic differently

                // Get current params if needed, or just trust arguments

                const category = categoryInput || 'all';
                renderProducts(category, searchQuery);
                updateFilterButtons(category);
            }

            function updateFilterButtons(category) {
                const buttons = document.querySelectorAll('button[data-category]');
                buttons.forEach(btn => {
                    const btnCat = btn.dataset.category;
                    if (btnCat === category) {
                        btn.className = "px-6 py-2.5 rounded-xl text-sm font-bold transition-all duration-300 bg-white text-primary shadow-lg scale-105";
                    } else {
                        btn.className = "px-6 py-2.5 rounded-xl text-sm font-bold text-white transition-all duration-300 hover:bg-white/20";
                    }
                });
            }

            // เริ่มทำงานเมื่อเปิดหน้าเว็บ
            document.addEventListener('DOMContentLoaded', () => {

                // Listen to real-time updates
                initProductListener((fetchedProducts) => {
                    products = fetchedProducts;

                    // Re-run filter logic with new data
                    const urlParams = new URLSearchParams(window.location.search);
                    const search = urlParams.get('search');
                    const category = urlParams.get('category') || 'all'; // Default to All

                    if (search) {
                        filterProducts('all', search);
                    } else {
                        filterProducts(category);
                    }
                });

                updateBadge();
            });
        </script>

</body>

</html>